{
    "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "networkResourceGroupName": {
            "type": "string",
            "metadata": {
                "description": "Name of the resource group containing the network resources."
            }
        },
        "networkResourceGroupTags": {
            "type": "object",
            "metadata": {
                "description": "Key-value pairs of Resource group tags."
            }
        },
        "vnetName": {
            "type": "string",
            "metadata": {
                "description": "Name of the virutal network."
            }
        },
        "vnetAddressSpace": {
            "type": "string",
            "metadata": {
                "description": "Address space of the virtual network."
            }
        },
        "gatewaySubnetAddressSpace": {
            "type": "string",
            "metadata": {
                "description": "Address space of the virtual network's gateway subnet"
            }
        },
        "subnetNames": {
            "type": "array",
            "metadata": {
                "description": "List of subnet names.  One subnet will be created for each name."
            }
        },
        "subnetAddressSpaces": {
            "type": "array",
            "metadata": {
                "description": "List of subnet address spaces.  The number of address spaces much match the count of subnet names."
            }
        },
        "subnetNsgNames": {
            "type": "array",
            "metadata": {
                "description": "List of subnet NSG names.  Use NONE for no NSG.  The number of NSG names must match the count of subnet names."
            }
        },
        "asaResourceGroupName": {
            "type": "string",
            "metadata": {
                "description": "Name of the resource group containing the network resources."
            }
        },
        "asaResourceGroupTags": {
            "type": "object",
            "metadata": {
                "description": "Key-value pairs of Resource group tags."
            }
        },
        "assetLocationURI": {
            "type": "string",
            "metadata": {
                "description": "URI that points to the linked ARM templates."
            }
        }
    },
    "functions": [],
    "variables": {
        "constants": {
            "location": "[deployment().location]",
            "resourceGroupLocation": "eastus2",
            "templateLocationURI": "[concat(parameters('assetLocationURI'), 'Templates/')]"
        },
        "deploymentName": "[deployment().Name]",
        "deploymentNames": {
            //"networkResourceGroup": "[concat(variables('deploymentName'), '-Network-ResourceGroup')]",
            "vnet": "[concat(variables('deploymentName'), '-Network-VNet')]"
        }
    },
    "resources": [
        {
            "comments": "Network Resource Group",
            "type": "Microsoft.Resources/resourceGroups",
            "apiVersion": "2020-10-01",
            "name": "[parameters('networkResourceGroupName')]",
            "location": "[variables('constants').resourceGroupLocation]",
            "tags": "[parameters('networkResourceGroupTags')]"
        },
        {
            "comments": "Route Tables",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "[concat(parameters('subnetNames')[copyIndex()], '-rt')]",
            "resourceGroup": "[parameters('networkResourceGroupName')]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('constants').templateLocationURI, 'RouteTable.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "routeTable_name": {"value": "[concat(parameters('subnetNames')[copyIndex()], '-rt')]"}
                }
            },
            "copy": {
                "name": "routeTablesLoop",
                "count": "[length(parameters('subnetNames'))]"
            }
        },
        {
            "comments": "Route Table for Gateway Subnet",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "fluor-sea-prod-gw-subnet-rt",
            "resourceGroup": "[parameters('networkResourceGroupName')]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('constants').templateLocationURI, 'RouteTable.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "routeTable_name": {"value": "fluor-sea-prod-gw-subnet-rt"}
                }
            }
        },
        {
            "comments": "VNet",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-10-01",
            "name": "[variables('deploymentNames').vnet]",
            "resourceGroup": "[parameters('networkResourceGroupName')]",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/resourceGroups/', parameters('networkResourceGroupName'))]",
                "routeTablesLoop"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('constants').templateLocationURI, 'VNet.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "virtualNetwork_name": {"value": "[parameters('vnetName')]"},
                    "virtualNetwork_addressSpace": {"value": "[parameters('vnetAddressSpace')]"},
                    "subnet_gateway_addressSpace": {"value": "[parameters('gatewaySubnetAddressSpace')]"},
                    "subnet_Names": {"value": "[parameters('subnetNames')]"},
                    "subnet_Addresses": {"value": "[parameters('subnetAddressSpaces')]"},
                    "subnet_NSG_Names": { "value": "[parameters('subnetNsgNames')]"}
                }
            }
        },
        {
            "comments": "ASA NVA Resource Group",
            "type": "Microsoft.Resources/resourceGroups",
            "apiVersion": "2020-10-01",
            "name": "[parameters('asaResourceGroupName')]",
            "location": "[variables('constants').resourceGroupLocation]",
            "tags": "[parameters('asaResourceGroupTags')]"
        }
    ],
    "outputs": {}
}